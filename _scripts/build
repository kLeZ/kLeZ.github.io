#!/bin/bash
set -e # halt script on error

bundle exec jekyll doctor

if [[ $CI == "true" ]]; then
	tee _data/ci-status.yml <<EOF
last_commit:
    short_sha: $(echo ${TRAVIS_COMMIT:-abcdef01} | cut -c 1-8)
    long_sha: ${TRAVIS_COMMIT:-abcdef01abcdef01abcdef01abcdef01abcdef01}
    message: |- $(echo; echo -e "${TRAVIS_COMMIT_MESSAGE}" | sed 's/^/        /')
build:
    number: ${TRAVIS_BUILD_NUMBER:-0}
    id: ${TRAVIS_BUILD_ID:-0}
    url: ${TRAVIS_BUILD_WEB_URL:-https://example.org}
EOF
	echo -e "\n"
	bundle exec jekyll build
else
	bash ./_scripts/publish
	bash ./_scripts/emojis
	cat _data/ci-status.yml
	echo -e "\n"
	bundle exec jekyll build --drafts --trace
fi

bundle exec htmlproofer ./_site --disable-external
